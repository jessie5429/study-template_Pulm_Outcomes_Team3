# Auto Data Partner Status Update Workflow
# Triggers when Data Partner issue labels are changed (indicating project status change)
# Per briefing/workflows/reusable.md and briefing/security/best-practices.md

name: Auto Update Data Partner Status

on:
  issues:
    types: [labeled, unlabeled]

# Per briefing/actions/permissions.md - minimal permissions
permissions:
  contents: read
  issues: write
  repository-projects: read

jobs:
  auto-update-status:
    runs-on: ubuntu-latest
    # Only process data-partner issues
    if: contains(github.event.issue.labels.*.name, 'data-partner')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Label Change
        id: process_change
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const label = context.payload.label;
            const action = context.payload.action;
            
            console.log('Issue label event received');
            console.log('Action:', action);
            console.log('Issue number:', issue.number);
            console.log('Label:', label.name);
            
            // Check if this is a status label change
            const statusLabels = {
              'status:preparation': 'Preparation',
              'status:analysis': 'Analysis', 
              'status:results': 'Results'
            };
            
            let newStatus = null;
            let isStatusChange = false;
            
            if (action === 'labeled' && statusLabels[label.name]) {
              // A status label was added
              newStatus = statusLabels[label.name];
              isStatusChange = true;
              console.log('Status label added:', label.name, '-> Status:', newStatus);
            } else if (action === 'unlabeled' && statusLabels[label.name]) {
              // A status label was removed - we need to check what status labels remain
              const remainingLabels = issue.labels.map(l => l.name);
              console.log('Status label removed:', label.name);
              console.log('Remaining labels:', remainingLabels);
              
              // Find any remaining status labels
              for (const [labelName, status] of Object.entries(statusLabels)) {
                if (remainingLabels.includes(labelName)) {
                  newStatus = status;
                  isStatusChange = true;
                  break;
                }
              }
              
              if (!newStatus) {
                // No status labels remain, default to Preparation
                newStatus = 'Preparation';
                isStatusChange = true;
                console.log('No status labels remain, defaulting to Preparation');
              }
            }
            
            if (!isStatusChange) {
              console.log('This is not a status label change, skipping');
              core.setOutput('should_update', 'false');
              return;
            }
            
            console.log('✅ Data partner status change detected');
            core.setOutput('should_update', 'true');
            core.setOutput('issue_number', issue.number.toString());
            core.setOutput('new_status', newStatus);
            core.setOutput('repo_name', context.repo.repo);

      - name: Update Data Partner Status
        if: steps.process_change.outputs.should_update == 'true'
        uses: ./.github/actions/update-data-partner-status
        with:
          issue_number: ${{ steps.process_change.outputs.issue_number }}
          new_status: ${{ steps.process_change.outputs.new_status }}
          repo_name: ${{ steps.process_change.outputs.repo_name }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Summary
        if: steps.process_change.outputs.should_update == 'true'
        run: |
          echo "## ✅ Auto Data Partner Status Updated"
          echo ""
          echo "**Repository:** ${{ steps.process_change.outputs.repo_name }}"
          echo "**Issue:** #${{ steps.process_change.outputs.issue_number }}"
          echo "**New Status:** ${{ steps.process_change.outputs.new_status }}"